# Lesson 7: 進階相依性管理

在大型專案或團隊協作中，確保每個開發者和部署環境都使用完全相同的套件版本至關重要。這可以避免 "在我電腦上可以跑" 的問題。`uv` 提供了強大的工具來實現這一點：`uv pip compile` 和 `uv sync`。

## `uv pip compile`: 鎖定你的相依性

`uv pip compile` 指令可以讀取你的高階相依性檔案 (例如 `requirements.in` 或 `pyproject.toml`)，並產生一個**完全鎖定**的 `requirements.txt` 檔案。這個檔案會包含所有直接和間接相依套件的確切版本和雜湊值。

### 使用 `requirements.in`

1.  建立一個 `requirements.in` 檔案，只列出你專案直接需要的套件：

    `requirements.in`:
    ```
    fastapi
    uvicorn
    ```

2.  執行 `compile` 指令：

    ```bash
    uv pip compile requirements.in -o requirements.txt
    ```

3.  `uv` 會產生一個 `requirements.txt` 檔案，內容可能像這樣 (版本號和雜湊值會不同)：

    `requirements.txt`:
    ```
    #
    # This file was autogenerated by uv via the following command:
    #
    #   uv pip compile requirements.in -o requirements.txt
    #
    anyio==4.4.0
        # via fastapi
    fastapi==0.111.0
        # via -r requirements.in
    h11==0.14.0
        # via uvicorn
    # ... (其他所有間接相依套件)
    uvicorn==0.30.1
        # via -r requirements.in
    ```

### 使用 `pyproject.toml`

如果你的相依性定義在 `pyproject.toml` 中，`uv` 也可以直接讀取它：

```bash
uv pip compile pyproject.toml -o requirements.txt
```

如果你有開發相依性，你可以使用 `--dev` 旗標將它們也包含進來：

```bash
uv pip compile pyproject.toml --dev -o requirements-dev.txt
```

## `uv sync`: 同步你的環境

當你有了鎖定的 `requirements.txt` 檔案後，`uv sync` 指令可以確保你的虛擬環境**完全符合**這個檔案的內容。

```bash
uv sync --require-hashes requirements.txt
```

`uv sync` 會：
- **安裝** `requirements.txt` 中有但環境中沒有的套件。
- **移除** 環境中有但 `requirements.txt` 中沒有的套件。
- **升級/降級** 環境中版本不符的套件。

`--require-hashes` 旗標會驗證下載檔案的雜湊值，確保你安裝的檔案與 `compile` 時完全相同，增加安全性。

## 建議的工作流程

1.  **定義**：在 `pyproject.toml` 或 `requirements.in` 中定義你的高階相依性。
2.  **鎖定**：修改相依性後，執行 `uv pip compile` 來更新 `requirements.txt`。
3.  **提交**：將 `pyproject.toml` (或 `requirements.in`) 和 `requirements.txt` 都提交到你的版本控制系統 (例如 Git)。
4.  **同步**：團隊成員或 CI/CD 系統在拿到最新程式碼後，執行 `uv sync` 來建立或更新他們的虛擬環境。

這個流程確保了每個人都在一個一致且可重現的環境中工作。

## 練習

1.  建立一個 `requirements.in` 檔案，並加入 `pandas`。
2.  使用 `uv pip compile` 產生 `requirements.txt`。觀察 `pandas` 的相依套件 (如 `numpy`, `pytz` 等) 是如何被加入的。
3.  執行 `uv sync` 來安裝所有套件。
4.  在 `requirements.in` 中加入 `matplotlib`，然後重新執行 `compile` 和 `sync`。觀察環境的變化。
5.  手動在虛擬環境中安裝一個 `requirements.txt` 裡沒有的套件 (例如 `uv pip install cowsay`)。
6.  再次執行 `uv sync`，觀察 `cowsay` 是如何被自動移除的。
